
import os
from pathlib import Path
from cryptography.hazmat.primitives.asymmetric import ed25519
from cryptography.hazmat.primitives import serialization
from dataclasses import dataclass


def generate_ssh_keypair():
    private_key = ed25519.Ed25519PrivateKey.generate()
    private_bytes = private_key.private_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PrivateFormat.OpenSSH,
        encryption_algorithm=serialization.NoEncryption()
    )
    public_key = private_key.public_key()
    public_bytes = public_key.public_bytes(
        encoding=serialization.Encoding.OpenSSH,
        format=serialization.PublicFormat.OpenSSH
    )
    return private_bytes, public_bytes

def generate_public_bytes(private_bytes):
    loaded_key = serialization.load_ssh_private_key(private_bytes, password=None)
    public_key = loaded_key.public_key()
    return public_key.public_bytes(
        encoding=serialization.Encoding.OpenSSH,
        format=serialization.PublicFormat.OpenSSH
    )


def save_private_key(key_bytes, filepath):
    filepath = Path(filepath).expanduser()
    filepath.parent.mkdir(parents=True, exist_ok=True)
    
    # Write the key
    filepath.write_bytes(key_bytes)
    
    # Set permissions to 0o600 (owner read/write only)
    os.chmod(filepath, 0o600)


def retrieve_private_key(filepath):
    filepath = Path(filepath).expanduser()
    content = filepath.read_bytes()
    return content


@dataclass
class PeerInfo:
    name: str
    private_key: str
    public_key: str


def generate_wireguard_keypair():
    return "private", "public"



def add_peer(name):
    private_key, public_key = generate_wireguard_keypair()
    return PeerInfo(name=name, private_key=private_key, public_key=public_key)


def deploy_server_keys(c, key_dir=/etc/wireguard):
    cmd1 = f"wg genkey | tee {key_dir}/private.key"
    cmd2 = f"cat {key_dir}/private.key | wg pubkey | tee {key_dir}/public.key"
    c.sudo(cmd1, hide=True)
    c.sudo(cmd2, hide=True)